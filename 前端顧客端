<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§ç¾é£Ÿåœ°åœ– ğŸ¢</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      background-color: #fffaf5;
    }
    header {
      background-color: #ff7043;
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
    }
    .buttons {
      text-align: center;
      margin: 15px;
    }
    button {
      background-color: #ff7043;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 25px;
      margin: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #ff5722;
    }
    input[type="text"] {
      width: 70%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #map {
      height: 70vh;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
    }
    .menu-popup, .order-popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 15px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: fadeIn 0.3s ease-in-out;
    }
    .menu-popup {
      width: 90%; max-width: 420px; padding: 20px;
    }
    .order-popup {
      width: 80%; max-width: 300px; padding: 20px; text-align: center;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translate(-50%, -40%);}
      to {opacity: 1; transform: translate(-50%, -50%);}
    }
    .menu-popup h3 { text-align: center; color: #ff7043; }
    .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
    .menu-item img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin-right: 10px; }
    .menu-info { flex: 1; }
    .order-btn { background-color: #ff7043; color: white; border: none; border-radius: 8px; padding: 5px 10px; cursor: pointer; }
    .order-btn:hover { background-color: #ff5722; }
    .close-btn { display: block; text-align: center; background-color: #ff7043; color: white; border-radius: 8px; padding: 8px; margin-top: 10px; cursor: pointer; }
    .rating { text-align: center; margin: 10px 0; }
    .star { font-size: 25px; color: #ccc; cursor: pointer; transition: color 0.2s; }
    .star.selected { color: #ffb400; }
    .comment-section textarea { width: 100%; border-radius: 8px; border: 1px solid #ccc; padding: 8px; font-size: 14px; resize: none; }
    .comment-list { margin-top: 10px; max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 5px; }
    .comment-item { background-color: #fff8f3; padding: 5px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
  </style>
</head>
<body>

<header>ğŸ¢ æ™ºæ…§ç¾é£Ÿåœ°åœ–</header>

<div class="buttons">
  <button onclick="login()">ç™»å…¥</button>
  <button onclick="getLocation()">é–‹å•Ÿå®šä½</button><br>
  <input type="text" id="searchInput" placeholder="è¼¸å…¥æƒ³åƒçš„é£Ÿç‰©åç¨±..." />
  <button onclick="searchFood()">æœå°‹</button>
</div>

<div id="map"></div>

<!-- èœå–®è¦–çª— -->
<div id="menuPopup" class="menu-popup">
  <h3 id="storeName">åº—å®¶åç¨±</h3>
  <p><strong>ç‡Ÿæ¥­æ™‚é–“ï¼š</strong><span id="storeTime"></span></p>
  <ul id="menuList"></ul>

  <div class="rating">
    <span class="star" onclick="rateStar(1)">â˜…</span>
    <span class="star" onclick="rateStar(2)">â˜…</span>
    <span class="star" onclick="rateStar(3)">â˜…</span>
    <span class="star" onclick="rateStar(4)">â˜…</span>
    <span class="star" onclick="rateStar(5)">â˜…</span>
    <p id="ratingText">å°šæœªè©•åˆ†</p>
  </div>

  <div class="comment-section">
    <textarea id="commentInput" rows="3" placeholder="ç•™ä¸‹æ‚¨çš„è©•è«–..."></textarea>
    <button onclick="addComment()">é€å‡ºç•™è¨€</button>
    <div class="comment-list" id="commentList"></div>
  </div>

  <div class="close-btn" onclick="closeMenu()">é—œé–‰</div>
</div>

<!-- é è³¼è¦–çª— -->
<div id="orderPopup" class="order-popup">
  <h3 id="orderItemName"></h3>
  <p>è«‹è¼¸å…¥é è³¼ä»½æ•¸ï¼š</p>
  <input type="number" id="orderQuantity" min="1" value="1" />
  <div>
    <button class="order-btn" onclick="confirmOrder()">ç¢ºèªé è³¼</button>
    <button class="close-btn" onclick="closeOrder()">å–æ¶ˆ</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

let map, userMarker, userCircle, currentStall = null;
let currentOrderItem = null;
let currentRating = 0;
const commentsData = {};
const ratingData = {};

// â­â­â­ æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦ç‡Ÿæ¥­ä¸­ â­â­â­
function isOpen(timeStr) {
  const [open, close] = timeStr.split(" - ");
  const now = new Date();
  const current = now.getHours() * 60 + now.getMinutes();

  const [openH, openM] = open.split(":").map(Number);
  const [closeH, closeM] = close.split(":").map(Number);

  const openMin = openH * 60 + openM;
  const closeMin = closeH * 60 + closeM;

  // è·¨åˆå¤œ
  if (closeMin < openMin) {
    return current >= openMin || current <= closeMin;
  }
  return current >= openMin && current <= closeMin;
}

function login() {
  alert("ç™»å…¥æˆåŠŸï¼ï¼ˆç¤ºç¯„ï¼‰");
}

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  } else alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
}

function showPosition(position) {
  const lat = position.coords.latitude;
  const lng = position.coords.longitude;

  if (!map) {
    map = L.map('map').setView([lat, lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap è²¢ç»è€…'
    }).addTo(map);
  }

  if (userMarker) map.removeLayer(userMarker);
  if (userCircle) map.removeLayer(userCircle);
  userMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ æ‚¨çš„ä½ç½®");
  userCircle = L.circle([lat, lng], {
    color: 'orange', fillColor: '#ffa726', fillOpacity: 0.2, radius: 5000
  }).addTo(map);

  // æ”¤è²©è³‡æ–™
  window.stalls = [
    { name: "é˜¿æ˜é¹½é…¥é›", lat: lat + 0.003, lng: lng + 0.002, time: "17:00 - 00:00",
      menu: [
        { item: "é¹½é…¥é›", price: 60, remain: 12, img: "https://i.imgur.com/4eY5JzC.jpg" },
        { item: "ç”œä¸è¾£", price: 40, remain: 5, img: "https://i.imgur.com/LO6u5uf.jpg" },
        { item: "åœ°ç“œè–¯æ¢", price: 35, remain: 8, img: "https://i.imgur.com/qyH7V5f.jpg" }
      ]},
    { name: "çç å¥¶èŒ¶æ”¤", lat: lat - 0.004, lng: lng + 0.001, time: "10:00 - 22:00",
      menu: [
        { item: "çç å¥¶èŒ¶", price: 50, remain: 20, img: "https://i.imgur.com/hD8ZrOQ.jpg" },
        { item: "å†¬ç“œæª¸æª¬", price: 45, remain: 9, img: "https://i.imgur.com/kGjD5y3.jpg" },
        { item: "ç´…èŒ¶æ‹¿éµ", price: 55, remain: 15, img: "https://i.imgur.com/qK9mAsv.jpg" }
      ]},
    { name: "é˜¿å©†æ»·å‘³", lat: lat + 0.002, lng: lng - 0.003, time: "16:00 - 23:00",
      menu: [
        { item: "æ»·è±†å¹²", price: 25, remain: 10, img: "https://i.imgur.com/Z1lYoJq.jpg" },
        { item: "æ»·è›‹", price: 15, remain: 18, img: "https://i.imgur.com/AnRNYgo.jpg" },
        { item: "æ»·æµ·å¸¶", price: 20, remain: 14, img: "https://i.imgur.com/L1Nlmwb.jpg" }
      ]},
    { name: "å¹¸ç¦ç« é­šç‡’", lat: lat + 0.001, lng: lng + 0.004, time: "15:30 - 22:30",
      menu: [
        { item: "ç« é­šç‡’(6é¡†)", price: 60, remain: 10, img: "https://i.imgur.com/1F8LkOa.jpg" },
        { item: "æ˜å¤ªå­ç« é­šç‡’", price: 75, remain: 6, img: "https://i.imgur.com/VJFGmyR.jpg" }
      ]},
    { name: "æ­£å®—ç‰›è‚‰éºµ", lat: lat - 0.002, lng: lng - 0.004, time: "11:00 - 20:30",
      menu: [
        { item: "ç´…ç‡’ç‰›è‚‰éºµ", price: 120, remain: 15, img: "https://i.imgur.com/r1NwDuf.jpg" },
        { item: "æ¸…ç‡‰ç‰›è‚‰éºµ", price: 120, remain: 10, img: "https://i.imgur.com/jc0vhfD.jpg" }
      ]}
  ];

  renderStalls();
}

// â­â­â­ ä¿®æ”¹ï¼šåœ°åœ–é¡¯ç¤ºç‡Ÿæ¥­ç‹€æ…‹ â­â­â­
function renderStalls(filteredList = null) {
  if (!map) return;
  if (window.stallMarkers) window.stallMarkers.forEach(m => map.removeLayer(m));

  const list = filteredList || [...window.stalls];
  list.sort((a, b) => (ratingData[b.name] || 0) - (ratingData[a.name] || 0));

  const top3 = list.filter(s => ratingData[s.name]).slice(0, 3);
  const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];

  window.stallMarkers = [];
  list.forEach((s, i) => {
    let rank = "";
    const topIndex = top3.indexOf(s);
    if (topIndex >= 0) rank = medals[topIndex] + " ";

    const status = isOpen(s.time) ? "ğŸŸ¢ ç‡Ÿæ¥­ä¸­" : "ğŸ”´ å·²ä¼‘æ¯";

    const marker = L.marker([s.lat, s.lng]).addTo(map);
    marker.bindPopup(`
      <b>${rank}${s.name}</b><br>
      ${status}<br>
      å¹³å‡è©•åˆ†ï¼š${ratingData[s.name] || "å°šç„¡"}<br>
      <button onclick="openMenu('${s.name}')">æŸ¥çœ‹èœå–®</button>
    `);
    marker.on("click", () => currentStall = s);
    window.stallMarkers.push(marker);
  });
}

function searchFood() {
  const keyword = document.getElementById("searchInput").value.trim();
  if (!keyword) { renderStalls(); return; }
  const results = window.stalls.filter(s => s.menu.some(m => m.item.includes(keyword)));
  if (results.length === 0) alert("æ‰¾ä¸åˆ°æœ‰è³£é€™é …é£Ÿç‰©çš„æ”¤ä½ï¼");
  renderStalls(results);
}

// â­â­â­ ä¿®æ”¹ï¼šèœå–®è¦–çª—é¡¯ç¤ºç‡Ÿæ¥­ç‹€æ…‹ â­â­â­
function openMenu(name) {
  const stall = window.stalls.find(s => s.name === name);
  if (!stall) return;
  currentStall = stall;

  document.getElementById("storeName").innerText = stall.name;

  const statusText = isOpen(stall.time) ? "ğŸŸ¢ ç‡Ÿæ¥­ä¸­" : "ğŸ”´ å·²ä¼‘æ¯";
  document.getElementById("storeTime").innerHTML = `${stall.time}ã€€${statusText}`;

  const list = document.getElementById("menuList");
  list.innerHTML = "";
  stall.menu.forEach(m => {
    const li = document.createElement("li");
    li.classList.add("menu-item");
    li.innerHTML = `
      <img src="${m.img}" alt="${m.item}">
      <div class="menu-info">
        <strong>${m.item}</strong><br>ğŸ’° $${m.price} ğŸ“¦ å‰©é¤˜ ${m.remain} ä»½
      </div>
      <button class="order-btn" onclick="openOrder('${m.item}')">â• é è³¼</button>
    `;
    list.appendChild(li);
  });

  loadComments();
  resetRating();
  document.getElementById("menuPopup").style.display = "block";
}

function openOrder(itemName) {
  currentOrderItem = itemName;
  document.getElementById("orderItemName").innerText = `é è³¼ï¼š${itemName}`;
  document.getElementById("orderPopup").style.display = "block";
}
function confirmOrder() {
  const qty = parseInt(document.getElementById("orderQuantity").value);
  if (qty > 0) {
    alert(`âœ… æ‚¨å·²æˆåŠŸé è³¼ ${currentOrderItem} ${qty} ä»½ï¼`);
    closeOrder();
  } else alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ä»½æ•¸ï¼");
}
function closeOrder() { document.getElementById("orderPopup").style.display = "none"; }
function closeMenu() { document.getElementById("menuPopup").style.display = "none"; }

function rateStar(value) {
  currentRating = value;
  document.querySelectorAll(".star").forEach((s, i) => s.classList.toggle("selected", i < value));
  document.getElementById("ratingText").innerText = `æ‚¨çµ¦äºˆäº† ${value} æ˜Ÿè©•åƒ¹`;
  const name = currentStall.name;
  if (!ratingData[name]) ratingData[name] = value;
  else ratingData[name] = Math.round((ratingData[name] + value) / 2 * 10) / 10;
  renderStalls();
}
function resetRating() {
  currentRating = 0;
  document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
  document.getElementById("ratingText").innerText = "å°šæœªè©•åˆ†";
}

function addComment() {
  const text = document.getElementById("commentInput").value.trim();
  if (!text) return alert("è«‹è¼¸å…¥ç•™è¨€ï¼");
  const store = currentStall.name;
  if (!commentsData[store]) commentsData[store] = [];
  commentsData[store].push(text);
  document.getElementById("commentInput").value = "";
  loadComments();
}
function loadComments() {
  const store = currentStall.name;
  const list = document.getElementById("commentList");
  list.innerHTML = "";
  if (commentsData[store]) {
    commentsData[store].forEach(c => {
      const div = document.createElement("div");
      div.classList.add("comment-item");
      div.innerText = c;
      list.appendChild(div);
    });
  }
}
function showError(error) {
  alert("å®šä½å¤±æ•—ï¼š" + error.message);
}

</script>
</body>
</html>
